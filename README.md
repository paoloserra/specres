# specres
Python script to estimate the spectral resolution of a data cube from its noise properties.

It assumes that the data cube is the convolution of an initial data cube whose channels are uncorrelated with a spectral convolution kernel `K`.

Spectra that contain real signal should be excluded from the analysis by giving a detection mask cube in input (see below).

The script does the following:
- extracts a set of unique random spectra from the datacube and calculates the autocorrelation `A_F` of each spectrum `F`;
- reconstructs the spectral convolution kernel `K` from the mean autocorrelation `<A_F>` as `K = IFT{+/- sqrt[FT(<A_F>)]}`, including a sign disambiguation algorithm;
- calculates the area of the spectral convolution kernel `K`;
- for reference, compares the mean autocorrelation `<A_F>` with the autocorrelation that would be generated by a set of analytical kernels selected by the user.

```
usage: specres.py [-h] -c CUBE [-m MASK] [-nspec NR_SPEC] [-nchan NR_CHAN] [-sinc SINC_KERNEL [SINC_KERNEL ...]] [-gauss GAUSS_KERNEL [GAUSS_KERNEL ...]] [-hann HANNING_KERNEL [HANNING_KERNEL ...]]
                  [-box BOXCAR_KERNEL [BOXCAR_KERNEL ...]] [-bin BINOMIAL_KERNEL [BINOMIAL_KERNEL ...]] [-notrack]
                  [-trackpar TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS] [-force FORCE_SIGN_CHANGE [FORCE_SIGN_CHANGE ...]]
                  [-interp INTERP_SIGN_CHANGE INTERP_SIGN_CHANGE INTERP_SIGN_CHANGE] [-floor NOISE_FLOOR]

required arguments:
  -c CUBE, --cube CUBE  Input FITS cube.

optional arguments:
  -h, --help            show this help message and exit
  -m MASK, --mask MASK  Optional FITS detection mask. Spectra including detected voxels are excluded from the analysis.
  -nspec NR_SPEC, --nr-spec NR_SPEC
                        Number of unique random spectra to be extracted from the input FITS cube. Default = 1000.
  -nchan NR_CHAN, --nr-chan NR_CHAN
                        Number of channels per spectrum. Default = 0 = all channels.
  -sinc SINC_KERNEL [SINC_KERNEL ...], --sinc-kernel SINC_KERNEL [SINC_KERNEL ...]
                        Space-separated list of scales for comparison Sinc kernels.
  -gauss GAUSS_KERNEL [GAUSS_KERNEL ...], --gauss-kernel GAUSS_KERNEL [GAUSS_KERNEL ...]
                        Space-separated list of widths for comparison Gaussian kernels.
  -hann HANNING_KERNEL [HANNING_KERNEL ...], --hanning-kernel HANNING_KERNEL [HANNING_KERNEL ...]
                        Space-separated list of widths for comparison Hanning kernels. Only odd numbers will be considered.
  -box BOXCAR_KERNEL [BOXCAR_KERNEL ...], --boxcar-kernel BOXCAR_KERNEL [BOXCAR_KERNEL ...]
                        Space-separated list of widths for comparison Box kernels. Only odd numbers will be considered.
  -bin BINOMIAL_KERNEL [BINOMIAL_KERNEL ...], --binomial-kernel BINOMIAL_KERNEL [BINOMIAL_KERNEL ...]
                        Space-separated list of widths for comparison Binomial kernels. Only odd numbers > 1 will be considered.

optional advanced arguments:
  -notrack, --no-track-sign-change
                        *** ADVANCED OPTION *** Skip the sign tracking of +/- sqrt[FT(<A_F>)]. This means always taking the + sign unless the user forces the sign change at specific points with -force.
  -trackpar TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS, --track-sign-change-params TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS TRACK_SIGN_CHANGE_PARAMS
                        *** ADVANCED OPTION *** Space-separated parameters of the algorithm that tracks the sign of +/- sqrt[FT(<A_F>)]. The algorithm looks for local minima sufficiently close to zero. The
                        five parameters are: 1) Half-width of the window used to check whether a point is a local minimum, to be rounded to the nearest integer. Default = 15. 2) Minimum fraction of points
                        with a larger value than the central point inside the above window. Must be between 0 and 1, with higher values giving fewer sign changes. Default = 0.7. 3) Minumum fraction of
                        points with a negative (positive) 1st derivative on the side closer to (farther from) the zero-frequency term. Must be between 0 and 1, with higher values giving fewer sign changes.
                        Default = 0.5. 4) Maximum ratio between the point and the peak. Must be between 0 and 1, with lower values giving fewer sign changes. Default = 0.1. 5) Minimum distance from another
                        local minimum candidate, to be rounded to the nearest integer. Points closer than this limit are grouped together in a friends-of-friends way, and only the median point of each group
                        is retained). Default = 5.
  -force FORCE_SIGN_CHANGE [FORCE_SIGN_CHANGE ...], --force-sign-change FORCE_SIGN_CHANGE [FORCE_SIGN_CHANGE ...]
                        *** ADVANCED OPTION *** Space-separated list of points where to force a sign change of sqrt[FT(<A_F>)]. Can only be used with -notrack, because the sign tracking algorithm would
                        generally give a conflicting list of points.
  -interp INTERP_SIGN_CHANGE INTERP_SIGN_CHANGE INTERP_SIGN_CHANGE, --interp-sign-change INTERP_SIGN_CHANGE INTERP_SIGN_CHANGE INTERP_SIGN_CHANGE
                        *** ADVANCED OPTION *** Space-separated parameters used for interpolating sqrt[FT(<A_F>)] across the sign-changing points, whether found by the sign tracking algorithm or given by
                        the user. Interpolation avoids abrupt jumps across the zero line in case of significan noise floor. The three parameters are: 1) Number of points to be included in the interpolation
                        on either side of the point. Default = 10. Set to 0 for no interpolation. 2) Order of the fit. Default = 2. 3) Number of points to be excluded from the interpolation on either side
                        of the point. If > 0, the above number of points included in the interpolation does not change, and the points included move outward. Default = 10.
  -floor NOISE_FLOOR, --noise-floor NOISE_FLOOR
                        *** ADVANCED OPTION *** Calculate the noise floor of FT(<A_F>) as the selected percentile (0 to 100), and subtract it before reconstructing the kernel K. Default = -1 = no noise
                        floor removal.
```
